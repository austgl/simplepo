<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
  <title>Simple PO - Edit Catalogue - </title>
  <link rel="stylesheet" href="incl/css/master.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <link rel="stylesheet" href="incl/css/edit.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <script src="incl/js/jquery-1.3.1.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="incl/js/json2.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">
    var msgs, dirty=false, currIdx = 1, srtBy="id";
    var  cat_id = window.location.href.substring( window.location.href.indexOf("edit.html?") + 10);
    cat_id = cat_id.substring( cat_id.indexOf('cat_id') + 7 );
    cat_id = (cat_id == "") ? 1 : parseInt(cat_id);

    $.messageService = function(method, params,callback,error_handler) {
      $.post('message_service.php',
          {request:JSON.stringify(
            {"method":method,
             "params":params,
              "id":Math.random()
              }
          )},
          function(obj) {
            if(obj.error) {
              error_handler ? error_handler(obj.error) : $('#errors span').text(obj.error.message + "  " + method).parent('#errors').show();
            } else {
              callback(obj.result);
            }
          },
          "json"
      );     
    };

    function Notifications(){
            this.hideAll = function(){
              this.hideError();
              this.hideMessage();
            };
            this.showError = function(err){
              $('#errors span').append(err + "<br />");
              $('#errors').fadeIn();
              $('#next').hide();
            };
            this.hideError = function(){
              $('#errors').fadeOut();
            };
            this.showMessage = function(msg){
              $('#messages span').append(msg + "<br />");
              $('#messages').fadeIn();
            };
            this.hideMessage = function(){
              $('#messages').fadeOut();
            };
            this.init = function(){ //Initialize all events and effects
              // Hide btns
              $('#errors #hideBtn').live('click', function(){$('#errors').fadeOut();});
              $('#messages #hideBtn').live('click', function(){$('#messages').fadeOut(500);$('#messages span').text("");});
            }
    };
    var NotificationObj = new Notifications();

    var initEvents = function(){
      // Add toggle effect
      $('#edit_bar .block h3 a.expand').click(function(){
        $(this).parents('.block').find('.data').toggle('fast');
      }).parents('.block').find('.data').toggle();

      // Add click event to message table entries
      $('#msg_table td').live("click",function() {
        prev = currIdx;
        currIdx = $('tr').index( $(this).parent('tr') ) - 1;
        nextMsgBlock(prev);
      });

      // Add click event to next button in the edit bar
      $('#next').live("click", function(e){
        e.preventDefault();
        prev = currIdx;
        currIdx = (currIdx % msgs.length) + 1;
        var top = ( $('#msg_table tr').height() * currIdx) - ($('#scroll_container').height() - ( $('#scroll_container').height() % $('#msg_table tr').height() )) / 2;
        $('#scroll_container').scrollTop( top );
        nextMsgBlock(prev);
      });

      // Jump to other Catalogues through drop down menu
      $('#catalogue_list').blur( function(){
        window.location.href = "edit.html?cat_id=" + ( $('#catalogue_list option:selected').attr('id') );
      });

      // Sort Table by the different headers
      $('#Olink').live("click", function(e){
          e.preventDefault();
          NotificationObj.showMessage('Sorted According to Original String.');
          srtBy="msgid";
          fillMsgTable(cat_id, srtBy);
      });
      $('#Tlink').live("click", function(e){
          e.preventDefault();
          NotificationObj.showMessage('Sorted According to Translation String.');
          srtBy="msgstr";
          fillMsgTable(cat_id, srtBy);
      });
      $('#Flink').live("click", function(e){
          e.preventDefault();
          NotificationObj.showMessage('Sorted According to Fuzzy.');
          srtBy="fuzzy";
          fillMsgTable(cat_id, srtBy);
      });
      $('#Dlink').live("click", function(e){
          e.preventDefault();
          NotificationObj.showMessage('Sorted According to Deprecated.');
          srtBy="obsolete"
          fillMsgTable(cat_id, srtBy);
      });

      // Initialize table size
      initPanels();
      // Add rollover effect to Side Bar
      var left = $('div.block').offset().left;
      var top = $('div.block').offset().top + $('div.block').height();
      $('#ref_head').live("mouseover", function(){
        $('#ref_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#ref_data').fadeOut();
      });
      $('#update_head').live("mouseover", function(){
        $('#update_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#update_data').fadeOut();
      });
      $('#src_com_head').live("mouseover", function(){
        $('#com_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#com_data').fadeOut();
      });
    };

    // Get the stored catalogues
    var getCatalogues = function( catId ){
      $.messageService('getCatalogues', [], function(data){
        if (data.length == 0){
          NotificationObj.showError("No PO Catalalogues Found.");
          return;
        }
        for (var i = 0; i<data.length; ++i){
            $("<option />").attr('id',data[i]['id']).text(data[i]['description']).appendTo($('#catalogue_list'));
        }
        if (catId > 0 && catId < data.length + 1){
          $('#cat_name').text(data[catId-1]['description']);
        } else {
          NotificationObj.showError("Catalogue [" + catId + "] Not Found.");
        }
      });
    };

    // Fill the table with all of the messages
    var fillMsgTable = function(id, sort){
      if ($('#errors span').text() != "") return;
      if (!sort) sort = "id";
      $.messageService('getMessages',[id, sort],function(data){
        if (data.length == 0){
          NotificationObj.showError("No Messages Found");
          return;
        }
        msgs = data;
        var msgid, msgstr, fuzzy='<td class="fuzzy"> </td>', depr='<td class="depr"> </td>';
        $('tbody tr').each( function(){$(this).remove();});
        for (var i=0; i < data.length; ++i){
          msgid = '<td class="msgid"><div><input type="text" name="id" id="id" value="' + data[i]['id'] + '" /><input type="text" name="idx" id="idx" value="' + i + '" />' + data[i]['msgid'] + '</div></td>';
          msgstr = '<td class="msgstr"><div>' + data[i]['msgstr'] + '</div></td>';
          $('#msg_table').append("<tr>" + msgid + msgstr + fuzzy + depr + "</tr>");
          if (data[i]['fuzzy'] == 1){
            $('#msg_table tr:last .fuzzy').addClass('f').text('F');
          }
          if (data[i]['obsolete'] == 1){
            $('#msg_table tr:last .depr').addClass('d').text('D');
          }
        }
        i = 0;
        $('#msg_table tr').each(function(){$(this).toggleClass(i++ %2 == 0 ? "odd" : "")});
        $('table').find('tbody tr:eq(' +(currIdx-1)+ ')').addClass('selected');
        fillEditBar();
      });
    };

    // Fill the Edit Bar with the selected message
    var fillEditBar = function(){
      var arr_idx = $('#msg_table tr:eq(' + (currIdx-1) + ') input:eq(1)').attr('value');
      var msg = msgs[arr_idx];
      $('#ref_data').html( (msg['reference'] != "") ? msg['reference'].replace( /\n/g, '<br />\n' ) : '-' );
      $('#com_data').html( (msg['extracted_comments'] != "") ? msg['extracted_comments'].replace(/\n/g, '<br />\n') : '-' );
      $('#update_data').html( (msg['updated_at'] != "") ? msg['updated_at'] : '-' );
      $('#comments').attr( 'value', msg['comments'] );
      $('#msgid').html( (msg['msgid'] != "" ) ? msg['msgid'].replace(/\n/g, '<br />\n') : "-" );
      $('#msgstr').attr( 'value', msg['msgstr'] );
      ( msg['fuzzy'] == 1 ) ? $('#fuzz').attr('checked',true) : $('#fuzz').attr('checked',false);
      $('#edit_id').attr( 'value', msg['id'] );
      $('#edit_idx').attr( 'value', arr_idx );
    };
    
    var onBlur = function(prev){
      // Check to see if the comments or translations have changed for the previous message
      var arr_idx = $('#msg_table tr:eq(' + (prev-1) + ') input:eq(1)').attr('value');
      var msg = msgs[arr_idx];
      if ( $('#id').attr('value') && $('#comments').attr('value') != msg['comments'] ){
        msgs[$('#msg_table tr:eq(' + (prev-1) + ') input:eq(1)').attr('value')]['comments'] = $('#comments').attr('value');
        dirty = true;
      }
      if ( $('#id').attr('value') && $('#msgstr').attr('value') != msg['msgstr'] ){
        msgs[$('#msg_table tr:eq(' + (prev-1) + ') input:eq(1)').attr('value')]['msgstr'] = $('#msgstr').attr('value');
        dirty = true;
      }
      if ( $('#id').attr('value') && $('#fuzz').attr('checked') != msg['fuzzy'] ){
        msgs[$('#msg_table tr:eq(' + (prev-1) + ') input:eq(1)').attr('value')]['fuzzy'] = !(msg['fuzzy']);
        dirty = true;
      }
      if (dirty){
        NotificationObj.showMessage("Attempting to update message...");
        $.messageService('updateMessage', [$('#edit_id').attr('value'), $('#comments').attr('value'), $('#msgstr').attr('value'), $('#fuzz').attr('checked')], function(){
          fillMsgTable(cat_id, srtBy);
          NotificationObj.showMessage("Message was updated successfully.");
        });
        dirty = false;
      }
    };

    var nextMsgBlock = function(prev){
      onBlur(prev);
      $('table').find('tbody tr').removeClass('selected');
      $('table').find('tbody tr:eq(' +(currIdx-1)+ ')').addClass('selected');
      fillEditBar();
    };

    $(function() {      
      getCatalogues(cat_id);
      fillMsgTable(cat_id);
      $('table').find('tbody tr:eq(' +(currIdx-1)+ ')').addClass('selected');

      NotificationObj.init();
      initEvents();
    });
   
    var initPanels = function(){
      $(this).resize(function() {
        var w = $(this).width();
        var h = $(this).height();
        var scroll_height = h - $('#scroll_container').offset().top - ( $('#foot').outerHeight() * 2);
        var l = $('#message_container').offset().left;
        $('#message_container').css({width:w-l});
        $('#msg_table,#msg_table_head').css({width:w-l-20});
        $('#scroll_container').css('height',scroll_height);
      }).resize();
    }

  </script>
</head>

<body><div id="body_w">
  <div id="errors">Error: <span></span><br /><input type="submit" name="hideBtn" id="hideBtn" value="Hide"></div>
  <div id="messages"><span></span><br /><input type="submit" name="hideBtn" id="hideBtn" value="Hide"></div>
  <div id="nav">
    <a href="#">Simple Po</a> 
    <a href="index.html" id="cat">Catalogue</a> 
    <div class="left">
      <span id="cat_name"></span>
    </div>
    <div class="right">
      <div id="cat_select">Switch Catalogue:
        <select id="catalogue_list"></select>
      </div>
    </div>
    <div style="clear:both"> </div>
  </div>

  <div id="edit_bar">
    <div class="block">
      <table id="edit_bar_table"><thead><tr>
        <th id="ref_head">Reference</th>
        <th id="update_head">Updated On</th>
        <th id="src_com_head">Source Comments</th></tr></thead>
      </table>
    </div>
    <div class="block">
      <h3><a href="#" id="trans_com_head" class="expand">Translation Comments</a></h3>
      <textarea id="comments" class="data" spellcheck="false"></textarea>
    </div>
    <div class="block">
      <h3><a href="#" id="orig_str_head">Original String (msgid)</a></h3>
      <div id="msgid" class="data">-</div>
    </div>
    <div class="block">
      <h3><a href="#" id="orig_str_head">Translation (msgstr)</a></h3>
      <textarea id="msgstr" class="data" spellcheck="false"></textarea>
    </div>
    <div class="block" id="cntrl_blk">
      <input type="checkbox" id="fuzz" name="fuzz" />Add/Remove Fuzzy Flag
      <input type="submit" id="next" name="next" value="Next Message &raquo;" />
      <input type="text" id="edit_id" name="edit_id" /><input type="text" id="edit_idx" name="edit_idx" />
    </div>
  </div>

  <div id="message_container">
    <table id="msg_table_head">
        <thead>
            <tr>
                <th class="msgid"><a href="#" title="Original String" id="Olink">Original String</a></th>
                <th class="msgstr"><a href="#" title="Translated String" id="Tlink">Translation</a></th>
                <th class="fuzzy"><a href="#" title="Fuzzy" id="Flink">F</a></th>
                <th class="depr"><a href="#" title="Deprecated" id="Dlink">D</a></th>
            </tr>
        </thead>
    </table>
    <div id="scroll_container">
        <table id="msg_table">
            <tbody></tbody>
        </table>
    </div>
  </div>

  <div id="foot">
    <span>-Footer Text-</span>
  </div>

  <div id="ref_data"></div>
  <div id="update_data"></div>
  <div id="com_data"></div>
</div></body>
</html>
