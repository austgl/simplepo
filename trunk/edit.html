<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
  <title>Simple PO - Edit Catalogue - </title>
  <link rel="stylesheet" href="incl/css/master.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <link rel="stylesheet" href="incl/css/edit.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <script src="incl/js/jquery-1.3.1.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="incl/js/jquery.tablesorter.js" type="text/javascript" charset="utf-8"></script>
  <script src="incl/js/json2.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">

    $.messageService = function(method, params,callback,error_handler) {
      $.post('message_service.php',
          {request:JSON.stringify(
            {"method":method,
             "params":params,
              "id":Math.random()
              }
          )},
          function(obj) {
            if(obj.error) {
              error_handler ? error_handler(obj.error) : $('#errors span').text(obj.error.message + "  " + method).parent('#errors').show();
            } else {
              callback(obj.result);
            }
          },
          "json"
      );     
    };

    function Notifications(){
            this.hideAll = function(){
              this.hideError();
              this.hideMessage();
            };
            this.showError = function(err){
              $('#errors span').append(err + "<br />");
              $('#errors').fadeIn();
              $('#next').hide();
            };
            this.hideError = function(){
              $('#errors').fadeOut();
            };
            this.showMessage = function(msg){
              $('#messages span').text(msg);
              $('#messages').fadeIn();
            };
            this.hideMessage = function(){
              $('#messages').fadeOut();
              $('#messages span').text("");
            };
            this.init = function(){
              // Hide btns
              $('#errors #hideBtn').live('click', function(){$('#errors').fadeOut();});
              $('#messages #hideBtn').live('click', function(){
                $('#messages').fadeOut();
              });
            };
    };
    var NotificationObj = new Notifications();

    var appController = (function() {
      var msgs;
      var cat_id = parseInt(window.location.href.match(/cat_id=(\d+)/)[1]);

      var initEvents = function() {
        // Add click event to message table entries
        $('#msg_table td').live("click",function() {
          selectMessage($(this).parent('tr').prevAll().length );
          document.getElementById('Olink').focus();
        });

        // Add click event to next button in the edit bar
        $('#next').live("click", function(e){
          e.preventDefault();
          moveBy(1)
          document.getElementById('Olink').focus();
        });
        
        $('#Olink').keydown( function(e){
            switch(e.which){
              case 37:
              case 38:
                moveBy(-1);
                break;
              case 39:
              case 40:
                moveBy(1);
                break;
            }
          });
      }

      var moveBy = function(num) {
        var moveTo = ( msgs.length + getCurrentMessage() + num ) % msgs.length;
        selectMessage(moveTo);
      }

      var selectMessage = function (index) {
        beforeBlur();
        $('#msg_table').find('tbody tr').removeClass('selected');
        var arr_index = $('#msg_table').find('tbody tr:eq(' +(index)+ ')').addClass('selected').data('index');
        fillEditBar(arr_index);
        setScroll();
      }

      var getCurrentMessage = function() {
        return $('#msg_table tr.selected').prevAll().length;
      }
      
      var beforeBlur = function(){
        if ( !$('#msg_table tr.selected').length ) return;
        var $row = $('#msg_table tr:eq(' + getCurrentMessage() + ')');    

        var msg = msgs[$row.data('index')];
        var dirty = $('#msgstr').val() != msg.msgstr || $('#comments').val() != msg.comments || $('#fuzz').is(':checked') != msg.fuzzy;

        if (dirty){
          msg.msgstr = $('#msgstr').val();
          msg.fuzzy = $('#fuzz').is(':checked');
          msg.comments = $('#comments').val();
          $row.trigger('sync');
          colorTable();
          NotificationObj.showMessage("Updated");
          $.messageService('updateMessage', [msg.id, $('#comments').val(), $('#msgstr').val(), $('#fuzz').is(':checked')], function() {
          });
        }
      };
      
      var setScroll = function() {
        var ot = $('#msg_table tr.selected').position().top - $('#msg_table').position().top;
        var sh = $('#scroll_container').height();
        $('#scroll_container').scrollTop( ot - (sh/2) );
      }
      
      // Fill the table with all of the messages
      var fillMsgTable = function(id){
        if ($('#errors span').text() != "") return;
      
        $.messageService('getMessages',[id, "id"],function(data){
          msgs = data;
          if (msgs.length == 0){
            NotificationObj.showError("No Messages Found");
            return;
          }
          $('tbody tr').remove();
          
          var sync = function () {
            var $row2 = $(this);
            var msg2 = msgs[$row2.data("index")];

            $row2.find('td.msgid div').text(msg2.msgid).end()
                      .find('td.msgstr div').text(msg2.msgstr);
            msg2.msgstr == "" ? $row2.addClass('empty') : $row2.removeClass('empty');
            msg2.fuzzy == 1 ? $row2.addClass('f').find('.fuzzy').text('F') : $row2.removeClass('f').find('.fuzzy').text('');
            msg2.obsolete && $row2.addClass('d').find('.depr').text('D');
          }
          
          for (var i=0; i < msgs.length; ++i) {
            //var msg = msgs[i];
            var $row = $('<tr><td class="msgid"><div/></td><td class="msgstr"><div/></td><td  class="fuzzy"></td><td class="depr"></td></tr>')
            $row.data('index',i);
            $row.bind('sync',sync).trigger('sync');
            $('#msg_table').append($row);
          }
          selectMessage(0);
          colorTable();
        });
      };

      // Fill the Edit Bar with the selected message
      var fillEditBar = function(index){
        var msg = msgs[index];
        $('#ref_data').html( (msg.referenc != "") ? msg.reference.replace( /\n/g, '<br />\n' ) : '-' );
        $('#com_data').html( (msg.extracted_comments != "") ? msg.extracted_comments.replace(/\n/g, '<br />\n') : '-' );
        $('#update_data').html( (msg.updated_at != "") ? msg.updated_at : '-' );
        $('#comments').attr( 'value', msg.comments );
        $('#msgid').html( (msg.msgid != "" ) ? msg.msgid.replace(/\n/g, '<br />\n') : "-" );
        $('#msgstr').attr( 'value', msg.msgstr );
        ( msg.fuzzy == 1 ) ? $('#fuzz').attr('checked',true) : $('#fuzz').attr('checked',false);
        $('#edit_id').attr( 'value', msg.id );
      };
      
      var _init = function() {
        getCatalogues(cat_id);
         // Sort Table by the different headers
        sortController.init();
          
        initPanels();
        fillMsgTable(cat_id);
        NotificationObj.init();
        initEvents();
      }
      return {
        init: function() {
          _init();
        }
      };
    })();
    $(appController.init);      
    
    var sortController = {
      init: function() {
        $('#msg_table_head thead th').click(function() {
          var column = $(this)
                                    .closest('thead')
                                    .find('th')
                                    .index(this);
           var direction = !!$(this).hasClass('sort-desc') ||
            !$(this).hasClass('sort-asc');
            $(this).siblings().andSelf().removeClass('sort-asc').removeClass('sort-desc');
            $(this).addClass(direction ? 'sort-asc' : 'sort-desc');
            direction = $('#msg_table_head thead th:eq(' + column + ')').text() == 'F' ? !direction : direction;
            direction = $('#msg_table_head thead th:eq(' + column + ')').text() == 'D' ? !direction : direction;
            $('#msg_table').tsort(column,direction);
            colorTable();
        });
      }
    };

    // Get the stored catalogues
    var getCatalogues = function( catId ){
      $.messageService('getCatalogues', [], function(data){
        if (data.length == 0){
          NotificationObj.showError("No PO Catalalogues Found.");
          return;
        }
        for (var i = 0; i<data.length; ++i){
            $("<option />").attr('id',data[i]['id']).text(data[i]['description']).appendTo($('#catalogue_list'));
        }
        if (catId > 0 && catId < data.length + 1){
          $('#cat_name').text(data[catId-1]['description']);
        } else {
          NotificationObj.showError("Catalogue [" + catId + "] Not Found.");
        }
      });
    };

    var colorTable = function() {
      var i=0;
      $('#msg_table tr').removeClass('odd');
      $('#msg_table tr').each( function() {
        $(this).toggleClass( i++ %2 == 0  && !$(this).hasClass('empty')? "odd" : "");
      });
    };
   
    var initPanels = function(){
      // Jump to other Catalogues through drop down menu
      $('#catalogue_list').blur( function(){
        window.location.href = "edit.html?cat_id=" + ( $('#catalogue_list option:selected').attr('id') );
      });
      
      // Add toggle effect
      $('#edit_bar .block h3 a.expand').click(function(){
        $(this).parents('.block').find('.data').toggle('fast');
      }).parents('.block').find('.data').toggle();
      
      // Add rollover effect to Side Bar
      var left = $('div.block').offset().left;
      var top = $('div.block').offset().top + $('div.block').height();
      $('#ref_head').live("mouseover", function(){
        $('#ref_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#ref_data').fadeOut();
      });
      $('#update_head').live("mouseover", function(){
        $('#update_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#update_data').fadeOut();
      });
      $('#src_com_head').live("mouseover", function(){
        $('#com_data').css({'left':left, 'top':top}).fadeIn('fast');
      }).live("mouseout", function(){
        $('#com_data').fadeOut();
      });
      
      $(this).resize(function() {
        var w = $(this).width();
        var h = $(this).height();
        var scroll_height = h - $('#scroll_container').offset().top - ( $('#foot').outerHeight() * 2);
        var l = $('#message_container').offset().left;
        $('#message_container').css({width:w-l});
        $('#msg_table,#msg_table_head').css({width:w-l-20});
        $('#scroll_container').css('height',scroll_height);
      }).resize();
      
    };

  </script>
</head>

<body onload="document.getElementById('Olink').focus()"><div id="body_w">
  <div id="errors">Error: <span></span><br /><input type="submit" name="hideBtn" id="hideBtn" value="Hide"></div>
  <div id="messages"><span></span><br /><input type="submit" name="hideBtn" id="hideBtn" value="Hide"></div>
  <div id="nav">
    <a href="#">Simple Po</a> 
    <a href="index.html" id="cat">Catalogue</a> 
    <div class="left">
      <span id="cat_name"></span>
    </div>
    <div class="right">
      <div id="cat_select">Switch Catalogue:
        <select id="catalogue_list"></select>
      </div>
    </div>
    <div style="clear:both"> </div>
  </div>

  <div id="edit_bar">
    <div class="block">
      <table id="edit_bar_table"><thead><tr>
        <th id="ref_head">Reference</th>
        <th id="update_head">Updated On</th>
        <th id="src_com_head">Source Comments</th></tr></thead>
      </table>
    </div>
    <div class="block">
      <h3><a href="#" id="trans_com_head" class="expand">Translation Comments</a></h3>
      <textarea id="comments" class="data" spellcheck="false"></textarea>
    </div>
    <div class="block">
      <h3><a href="#" id="orig_str_head">Original String (msgid)</a></h3>
      <div id="msgid" class="data">-</div>
    </div>
    <div class="block">
      <h3><a href="#" id="orig_str_head">Translation (msgstr)</a></h3>
      <textarea id="msgstr" class="data" spellcheck="false"></textarea>
    </div>
    <div class="block" id="cntrl_blk">
      <input type="checkbox" id="fuzz" name="fuzz" />Add/Remove Fuzzy Flag
      <input type="submit" id="next" name="next" value="Next Message &raquo;" />
    </div>
  </div>

  <div id="message_container">
    <table id="msg_table_head">
        <thead>
            <tr>
                <th class="msgid"><a href="#" title="Original String" id="Olink">Original String</a><img src="incl/img/blank.gif"/></th>
                <th class="msgstr"><a href="#" title="Translated String" id="Tlink">Translation</a><img src="incl/img/blank.gif"/></th>
                <th class="fuzzy"><a href="#" title="Fuzzy" id="Flink">F</a><img src="incl/img/blank.gif"/></th>
                <th class="depr"><a href="#" title="Deprecated" id="Dlink">D</a><img src="incl/img/blank.gif"/></th>
            </tr>
        </thead>
    </table>
    <div id="scroll_container">
        <table id="msg_table">
            <tbody></tbody>
        </table>
    </div>
  </div>

  <div id="foot">
    <span>-Footer Text-</span>
  </div>

  <div id="ref_data"></div>
  <div id="update_data"></div>
  <div id="com_data"></div>
</div></body>
</html>
